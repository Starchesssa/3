
name: Sort No Face Footage and Upload

on:
  workflow_dispatch:

jobs:
  sort-no-face:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download processed video artifact
        uses: dawidd6/action-download-artifact@v2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          workflow: Unusual_6download3.yml
          workflow_conclusion: success
          branch: main
          name: downloaded-videos
          path: Processed_Vid/

      - name: Install FFmpeg
        run: |
          echo "ğŸ”§ Updating packages and installing FFmpeg..."
          sudo apt-get update && sudo apt-get install -y ffmpeg

      - name: Cut No-Face Segments and Concatenate (Debug Enabled)
        run: |
          set -euxo pipefail  # Debugging enabled: stop on error, print commands
          
          echo "ğŸ“‚ Creating necessary directories..."
          mkdir -p No_Face_Videos Temp_Segments

          echo "ğŸš€ Starting to process NO_FACE groups..."
          for noface in Unuusual_memory/NO_FACE/group_*.txt; do
            base=$(basename "$noface" .txt)
            video="Processed_Vid/${base}.mp4"

            if [[ ! -f "$video" ]]; then
              echo "âš ï¸ Skipping $base - video not found at $video"
              continue
            fi

            echo "ğŸ¬ Processing $base with video: $video"
            seg_num=1
            concat_list="Temp_Segments/${base}_concat_list.txt"
            > "$concat_list"

            while IFS= read -r line; do
              line="$(echo "$line" | xargs)"
              if [[ -z "$line" || "$line" != *-* ]]; then
                echo "â­ï¸ Skipping invalid or empty line: '$line'"
                continue
              fi

              start="$(echo "$line" | cut -d'-' -f1 | xargs)"
              end="$(echo "$line" | cut -d'-' -f2 | xargs)"
              echo "âœ‚ï¸ Cutting segment: Start=$start, End=$end"

              ffmpeg -y -ss "$start" -to "$end" -i "$video" -c copy "Temp_Segments/${base}_seg_${seg_num}.mp4"
              echo "file '${base}_seg_${seg_num}.mp4'" >> "$concat_list"
              seg_num=$((seg_num + 1))
            done < "$noface"

            if [[ -s "$concat_list" ]]; then
              echo "ğŸ”— Concatenating segments for $base..."
              ffmpeg -y -f concat -safe 0 -i "$concat_list" -c copy "No_Face_Videos/${base}_noface.mp4"
              echo "âœ… Finished processing $base"
            else
              echo "âš ï¸ No valid segments found for $base, skipping concatenation."
            fi
          done

      - name: Upload No-Face Videos as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: no-face-videos
          path: No_Face_Videos/

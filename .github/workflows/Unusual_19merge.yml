
name: Sort No Face Footage and Upload

on:
  workflow_dispatch:

jobs:
  sort-no-face:
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout repository
        uses: actions/checkout@v4

      - name: 📥 Download processed video artifact
        uses: dawidd6/action-download-artifact@v2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          workflow: Unusual_6download3.yml
          workflow_conclusion: success
          branch: main
          name: downloaded-videos
          path: Processed_Vid/

      - name: 🔧 Install FFmpeg
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: ✂️ Cut No-Face Segments and Concatenate (MM:SS only)
        run: |
          set -euxo pipefail

          mkdir -p No_Face_Videos Temp_Segments

          for noface in Unuusual_memory/NO_FACE/group_*.txt; do
            base=$(basename "$noface" .txt)
            video="Processed_Vid/${base}.mp4"

            if [[ ! -f "$video" ]]; then
              echo "⚠️ Skipping $base - video not found."
              continue
            fi

            echo "🎬 Processing $base"

            seg_num=1
            concat_list="Temp_Segments/${base}_concat_list.txt"
            > "$concat_list"

            while IFS= read -r line || [[ -n "$line" ]]; do
              # Clean up BOM, carriage returns, and trim spaces
              line="$(echo "$line" | sed 's/^\xEF\xBB\xBF//' | tr -d '\r' | xargs)"

              # Debug: Show hidden characters (optional)
              printf '📄 Processing line: [%s]\n' "$line" | cat -v

              # Skip if invalid or not in mm:ss-mm:ss format
              if [[ ! "$line" =~ ^[0-9]{2}:[0-9]{2}-[0-9]{2}:[0-9]{2}$ ]]; then
                echo "⏭️ Skipping invalid line: '$line'"
                continue
              fi

              start="${line%-*}"
              end="${line#*-}"

              echo "✂️ Cutting segment from '$start' to '$end'"

              ffmpeg -y -ss "$start" -to "$end" -i "$video" -c copy "Temp_Segments/${base}_seg_${seg_num}.mp4"
              echo "file '${base}_seg_${seg_num}.mp4'" >> "$concat_list"
              seg_num=$((seg_num + 1))
            done < "$noface"

            if [[ -s "$concat_list" ]]; then
              echo "🔗 Concatenating segments for $base..."
              ffmpeg -y -f concat -safe 0 -i "$concat_list" -c copy "No_Face_Videos/${base}_noface.mp4"
              echo "✅ Finished processing $base"
            else
              echo "⚠️ No valid segments for $base, skipping."
            fi
          done

      - name: 📤 Upload No-Face Videos as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: no-face-videos
          path: No_Face_Videos/
